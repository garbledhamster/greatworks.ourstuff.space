<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Great Books Compass</title>
  <meta name="description" content="A static, idea-driven compass for Great Books of the Western World. Search by feeling or idea, get a clear reading pick with reasons." />

  <!-- Tailwind CDN (GitHub Pages friendly) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'Apple Color Emoji', 'Segoe UI Emoji']
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.18)'
          }
        }
      }
    }
  </script>

  <style>
    /* Small “HTML5UP-ish” touches */
    .grain {
      background-image:
        radial-gradient(circle at 25% 10%, rgba(255,255,255,.08), transparent 35%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,.06), transparent 40%),
        radial-gradient(circle at 15% 85%, rgba(255,255,255,.05), transparent 40%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 35%),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      background-blend-mode: screen, screen, screen, normal, overlay;
    }
    .fade-mask {
      -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
      mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
    }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 4px rgba(99,102,241,.35); }
    .kbd { border: 1px solid rgba(255,255,255,.18); }
    html { scroll-behavior: smooth; }
  </style>
</head>

<body class="min-h-screen bg-zinc-950 text-zinc-100 font-sans">
  <!-- Top gradient / hero background -->
  <div class="relative overflow-hidden">
    <div class="absolute inset-0 grain opacity-80"></div>
    <div class="absolute -top-28 -left-28 h-96 w-96 rounded-full blur-3xl opacity-40"
         style="background: radial-gradient(circle at 30% 30%, #6366f1, transparent 60%);"></div>
    <div class="absolute -top-24 -right-28 h-96 w-96 rounded-full blur-3xl opacity-35"
         style="background: radial-gradient(circle at 40% 40%, #22c55e, transparent 60%);"></div>

    <header class="relative z-10 mx-auto max-w-6xl px-5 pt-6">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-white/10 ring-1 ring-white/15 shadow-soft grid place-items-center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="opacity-90">
              <path d="M4 5.5C4 4.12 5.12 3 6.5 3H20v16H7.2c-1.77 0-3.2 1.43-3.2 3.2V5.5Z" stroke="currentColor" stroke-width="1.7"/>
              <path d="M20 19v2H7.2C5.43 21 4 19.57 4 17.8" stroke="currentColor" stroke-width="1.7"/>
              <path d="M8 7h8M8 10h7M8 13h5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div class="text-lg font-semibold tracking-tight">Great Books Compass</div>
            <div class="text-xs text-zinc-300/80">Static • GitHub Pages • Feeling → Idea → Book</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <a href="#library" class="text-sm px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition">Library</a>
          <button id="btnExport"
            class="text-sm px-3 py-2 rounded-lg bg-indigo-500/90 hover:bg-indigo-500 ring-1 ring-indigo-300/30 shadow-soft transition">
            Export book files
          </button>
        </div>
      </div>

      <div class="mt-10 pb-12">
        <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight leading-tight">
          Find the <span class="text-indigo-300">right Great Book</span> for what you’re feeling.
        </h1>
        <p class="mt-3 text-zinc-200/80 max-w-2xl">
          Type a feeling, a problem, or an idea. The compass maps your words to themes,
          then ranks GBWW volumes with transparent reasons.
        </p>

        <!-- Mode switch -->
        <div class="mt-6 flex flex-wrap items-center gap-2">
          <button id="tabCompass"
            class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/15 transition text-sm">
            Compass Mode
          </button>
          <button id="tabBrowse"
            class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm">
            Browse Mode
          </button>

          <div class="ml-auto hidden sm:flex items-center gap-2 text-xs text-zinc-300/80">
            <span class="kbd px-2 py-1 rounded-lg bg-white/5">Ctrl</span>+
            <span class="kbd px-2 py-1 rounded-lg bg-white/5">K</span>
            <span class="ml-1">to focus search</span>
          </div>
        </div>

        <!-- Search card -->
        <div class="mt-4 rounded-2xl bg-white/5 ring-1 ring-white/10 shadow-soft overflow-hidden">
          <div class="p-4 sm:p-5">
            <label class="block text-xs text-zinc-300/80 mb-2" for="q">
              What’s on your mind?
            </label>
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="flex-1">
                <input id="q" class="w-full focus-ring rounded-xl bg-zinc-950/60 ring-1 ring-white/10 px-4 py-3 text-base placeholder:text-zinc-500"
                  placeholder='e.g. "I feel sick and don’t want to do anything" or "I need courage" or "what is justice?"' />
                <div class="mt-2 text-xs text-zinc-400/80">
                  Tip: try <span class="text-zinc-200">“I’m anxious”</span>, <span class="text-zinc-200">“I feel directionless”</span>,
                  <span class="text-zinc-200">“I need motivation”</span>, <span class="text-zinc-200">“I’m grieving”</span>.
                </div>
              </div>

              <div class="flex gap-2">
                <button id="btnGo"
                  class="px-4 py-3 rounded-xl bg-indigo-500/90 hover:bg-indigo-500 ring-1 ring-indigo-300/30 shadow-soft transition text-sm font-medium">
                  Find me a book
                </button>
                <button id="btnClear"
                  class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm">
                  Clear
                </button>
              </div>
            </div>

            <div id="chips" class="mt-4 flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>
    </header>
  </div>

  <!-- Main -->
  <main class="relative z-10 mx-auto max-w-6xl px-5 pb-16">
    <!-- Compass results -->
    <section id="compassSection" class="mt-6 grid lg:grid-cols-3 gap-5">
      <div class="lg:col-span-2">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Recommendations</h2>
          <div class="text-xs text-zinc-400/80">
            Transparent scoring • no AI calls • all client-side
          </div>
        </div>

        <div id="results" class="mt-3 space-y-3"></div>

        <div id="emptyState" class="mt-4 rounded-2xl bg-white/4 ring-1 ring-white/10 p-6 text-zinc-200/80">
          <div class="text-sm">
            Type something above and hit <span class="text-zinc-100 font-medium">Find me a book</span>.
            You’ll see top matches and the exact reasons.
          </div>
        </div>
      </div>

      <aside class="lg:col-span-1">
        <div class="rounded-2xl bg-white/4 ring-1 ring-white/10 p-5 shadow-soft">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold">Why these picks</h3>
            <button id="btnExplain"
              class="text-xs px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition">
              Toggle details
            </button>
          </div>

          <div id="explain" class="mt-3 text-sm text-zinc-200/80 space-y-4">
            <div>
              <div class="text-xs uppercase tracking-wide text-zinc-400">Signals</div>
              <div id="signalList" class="mt-2 text-sm"></div>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wide text-zinc-400">How scoring works</div>
              <ul class="mt-2 text-sm list-disc pl-5 space-y-1 text-zinc-200/75">
                <li>Your words map to <span class="text-zinc-100">themes</span> and <span class="text-zinc-100">moods</span>.</li>
                <li>Each book has tags; overlaps add points. Short/accessible works get a bump when you sound tired/sick.</li>
                <li>You’ll see matched tags on each recommendation card.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="mt-5 rounded-2xl bg-white/4 ring-1 ring-white/10 p-5 shadow-soft">
          <h3 class="text-sm font-semibold">Your shelf</h3>
          <div class="mt-2 text-xs text-zinc-400/80">Star books to save them here (stored in localStorage).</div>
          <div id="shelf" class="mt-3 space-y-2"></div>
        </div>
      </aside>
    </section>

    <!-- Library -->
    <section id="library" class="mt-16">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-semibold tracking-tight">Library</h2>
          <p class="mt-1 text-sm text-zinc-300/80">All GBWW (1990) volumes, with tags you can extend over time.</p>
        </div>

        <div class="flex gap-2">
          <input id="librarySearch"
            class="w-full sm:w-80 focus-ring rounded-xl bg-white/5 ring-1 ring-white/10 px-4 py-2 text-sm placeholder:text-zinc-500"
            placeholder="Search title, author, work, tag…" />
          <button id="btnResetFilters"
            class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm">
            Reset
          </button>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <div class="text-xs text-zinc-400/80 mr-2">Quick filters:</div>
        <button data-filter="short" class="filterBtn px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-xs transition">Short-ish</button>
        <button data-filter="fiction" class="filterBtn px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-xs transition">Imaginative</button>
        <button data-filter="philosophy" class="filterBtn px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-xs transition">Philosophy</button>
        <button data-filter="science" class="filterBtn px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-xs transition">Science</button>
        <button data-filter="comfort" class="filterBtn px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-xs transition">Comforting</button>
      </div>

      <div id="libraryGrid" class="mt-5 grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>
  </main>

  <!-- Book detail modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden">
    <div id="modalOverlay" class="absolute inset-0 bg-black/70"></div>
    <div class="absolute inset-0 grid place-items-center p-4">
      <div class="w-full max-w-2xl rounded-2xl bg-zinc-950 ring-1 ring-white/15 shadow-soft overflow-hidden">
        <div class="p-4 sm:p-5 flex items-start justify-between gap-3">
          <div>
            <div id="modalTitle" class="text-lg font-semibold"></div>
            <div id="modalMeta" class="mt-1 text-sm text-zinc-300/80"></div>
          </div>
          <button id="modalClose"
            class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm">
            Close
          </button>
        </div>
        <div class="px-4 sm:px-5 pb-5">
          <div id="modalBody" class="text-sm text-zinc-200/85 space-y-3"></div>
          <div class="mt-4 flex flex-wrap gap-2">
            <a id="modalOpenFile" href="#" target="_blank" rel="noopener"
               class="px-3 py-2 rounded-xl bg-indigo-500/90 hover:bg-indigo-500 ring-1 ring-indigo-300/30 shadow-soft transition text-sm font-medium">
              Open book file
            </a>
            <button id="modalStar"
              class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm">
              Star / Unstar
            </button>
          </div>
          <div class="mt-3 text-xs text-zinc-500">
            “Open book file” points to <code class="text-zinc-300">books/&lt;slug&gt;.html</code>. Use <b>Export book files</b> to generate them.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // -----------------------------
    // Data: GBWW (1990) 60 volumes
    // -----------------------------
    const BOOKS = [
      mk(1,  "the-syntopicon-1", "The Syntopicon (Vol. I)", ["Mortimer J. Adler (ed.)"], ["Index to the Great Ideas (A–Love)"], ["reference","ideas","navigation"], ["tool","clarity"], "reference"),
      mk(2,  "the-syntopicon-2", "The Syntopicon (Vol. II)", ["Mortimer J. Adler (ed.)"], ["Index to the Great Ideas (Man–World)"], ["reference","ideas","navigation"], ["tool","clarity"], "reference"),

      mk(3,  "homer", "Homer", ["Homer"], ["The Iliad","The Odyssey"], ["war","honor","fate","courage","home","friendship"], ["epic","high-drama"], "long", {category:"imaginative"}),
      mk(4,  "greek-drama", "Greek Drama", ["Aeschylus","Sophocles","Euripides","Aristophanes"], ["Selected plays"], ["fate","justice","family","tragic-choice","courage","law"], ["catharsis","intense"], "medium", {category:"imaginative"}),
      mk(5,  "history-greece", "Herodotus & Thucydides", ["Herodotus","Thucydides"], ["Persian Wars","Peloponnesian War"], ["power","war","state","honor","history","human-nature"], ["serious","clear-eyed"], "long", {category:"history"}),
      mk(6,  "plato", "Plato", ["Plato"], ["Dialogues","The Seventh Letter"], ["justice","truth","soul","virtue","education","love","government"], ["inquiry","clarity"], "long", {category:"philosophy"}),
      mk(7,  "aristotle-1", "Aristotle (Vol. I)", ["Aristotle"], ["Selected works"], ["logic","ethics","politics","nature","reasoning","virtue"], ["structured","focused"], "long", {category:"philosophy"}),
      mk(8,  "aristotle-2", "Aristotle (Vol. II)", ["Aristotle"], ["Selected works (cont.)"], ["metaphysics","poetry","science","reasoning","nature"], ["structured","focused"], "long", {category:"philosophy"}),
      mk(9,  "hippocrates-galen", "Hippocrates & Galen", ["Hippocrates","Galen"], ["Selected works"], ["medicine","body","mind","nature","cause"], ["practical","grounding"], "medium", {category:"science", comfortTag:true}),
      mk(10, "math-greece", "Euclid / Archimedes / Nicomachus", ["Euclid","Archimedes","Nicomachus"], ["Elements","Selected works","Introduction to Arithmetic"], ["mathematics","reasoning","proof","form","quantity"], ["calm","precise"], "long", {category:"science"}),
      mk(11, "late-antiquity", "Lucretius / Epictetus / Marcus Aurelius / Plotinus", ["Lucretius","Epictetus","Marcus Aurelius","Plotinus"], ["The Way Things Are","Discourses","Meditations","Enneads"], ["mind","desire","happiness","virtue","life-and-death","soul"], ["low-energy","comfort","clarity"], "medium", {category:"philosophy", comfortTag:true}),
      mk(12, "virgil", "Virgil", ["Virgil"], ["Eclogues","Georgics","Aeneid"], ["fate","duty","honor","home","love"], ["epic","reflective"], "long", {category:"imaginative"}),
      mk(13, "plutarch-lives", "Plutarch", ["Plutarch"], ["Lives"], ["character","virtue","honor","leadership","education"], ["inspiring","reflective"], "long", {category:"history"}),
      mk(14, "tacitus", "Tacitus", ["Tacitus"], ["Annals","Histories"], ["power","tyranny","state","corruption","history"], ["grim","clear-eyed"], "long", {category:"history"}),
      mk(15, "astronomy-revolutions", "Ptolemy / Copernicus / Kepler", ["Ptolemy","Copernicus","Kepler"], ["Almagest","On the Revolutions","Selections"], ["astronomy","science","truth","hypothesis","world"], ["awe","precise"], "long", {category:"science"}),

      mk(16, "augustine", "Augustine", ["Augustine"], ["Confessions","City of God","On Christian Doctrine"], ["god","soul","sin","time","truth","love"], ["introspective","heavy"], "long", {category:"philosophy"}),
      mk(17, "aquinas-1", "Aquinas (Vol. I)", ["Thomas Aquinas"], ["Summa Theologica"], ["theology","reasoning","virtue","law","god"], ["systematic","serious"], "long", {category:"philosophy"}),
      mk(18, "aquinas-2", "Aquinas (Vol. II)", ["Thomas Aquinas"], ["Summa Theologica (cont.)"], ["theology","ethics","law","virtue","god"], ["systematic","serious"], "long", {category:"philosophy"}),
      mk(19, "dante-chaucer", "Dante / Chaucer", ["Dante","Chaucer"], ["Divine Comedy","Troilus and Criseyde","Canterbury Tales"], ["love","sin","virtue","journey","death","humor"], ["imaginative","varied"], "long", {category:"imaginative"}),
      mk(20, "calvin", "Calvin", ["John Calvin"], ["Institutes of the Christian Religion"], ["religion","theology","law","duty","god"], ["serious","structured"], "long", {category:"philosophy"}),
      mk(21, "machiavelli-hobbes", "Machiavelli / Hobbes", ["Machiavelli","Thomas Hobbes"], ["The Prince","Leviathan"], ["power","state","fear","law","tyranny","government"], ["hard-nosed","clear"], "long", {category:"politics"}),
      mk(22, "rabelais", "Rabelais", ["François Rabelais"], ["Gargantua and Pantagruel"], ["humor","education","custom","freedom","satire"], ["playful","weird"], "long", {category:"imaginative"}),
      mk(23, "erasmus-montaigne", "Erasmus / Montaigne", ["Erasmus","Montaigne"], ["Praise of Folly","Essays"], ["self-knowledge","custom","education","wisdom","habit"], ["low-energy","friendly","clarity"], "medium", {category:"philosophy", comfortTag:true}),
      mk(24, "shakespeare-1", "Shakespeare (Vol. I)", ["William Shakespeare"], ["Plays"], ["love","power","jealousy","honor","fate","ambition"], ["imaginative","high-drama"], "long", {category:"imaginative"}),
      mk(25, "shakespeare-2", "Shakespeare (Vol. II)", ["William Shakespeare"], ["Plays (cont.)","Sonnets"], ["love","time","beauty","desire","fate"], ["imaginative","reflective"], "long", {category:"imaginative"}),
      mk(26, "early-science", "Gilbert / Galileo / Harvey", ["William Gilbert","Galileo Galilei","William Harvey"], ["Loadstone","Two New Sciences","Selected works"], ["science","nature","cause","experiment"], ["curious","precise"], "medium", {category:"science"}),
      mk(27, "don-quixote", "Cervantes", ["Miguel de Cervantes"], ["Don Quixote"], ["idealism","reality","humor","self-deception","honor"], ["playful","big"], "long", {category:"imaginative"}),
      mk(28, "bacon-descartes-spinoza", "Bacon / Descartes / Spinoza", ["Francis Bacon","René Descartes","Baruch Spinoza"], ["Selected works"], ["reasoning","knowledge","method","mind","truth","god"], ["clarity","sharp"], "long", {category:"philosophy"}),
      mk(29, "milton", "Milton", ["John Milton"], ["Selected poems","Paradise Lost","etc."], ["good-and-evil","freedom","sin","god","will"], ["epic","intense"], "long", {category:"imaginative"}),
      mk(30, "pascal", "Pascal", ["Blaise Pascal"], ["Provincial Letters","Pensées","Treatises"], ["faith","reasoning","mind","god","doubt"], ["introspective","sharp"], "medium", {category:"philosophy"}),

      mk(31, "moliere-racine", "Molière / Racine", ["Molière","Racine"], ["Selected plays"], ["love","custom","honor","virtue-and-vice"], ["light","dramatic"], "medium", {category:"imaginative"}),
      mk(32, "newton-huygens", "Newton / Huygens", ["Isaac Newton","Christiaan Huygens"], ["Principia","Optics","Treatise on Light"], ["science","nature","cause","mechanics","truth"], ["precise","demanding"], "long", {category:"science"}),
      mk(33, "locke-berkeley-hume", "Locke / Berkeley / Hume", ["John Locke","George Berkeley","David Hume"], ["Selected works"], ["knowledge","mind","liberty","government","cause"], ["clarity","skeptical"], "long", {category:"philosophy"}),
      mk(34, "swift-voltaire-diderot", "Swift / Voltaire / Diderot", ["Jonathan Swift","Voltaire","Denis Diderot"], ["Gulliver’s Travels","Candide","Rameau’s Nephew"], ["satire","reason","optimism","custom","society"], ["funny","quick"], "medium", {category:"imaginative", comfortTag:true}),
      mk(35, "montesquieu-rousseau", "Montesquieu / Rousseau", ["Montesquieu","Jean-Jacques Rousseau"], ["Spirit of Laws","Discourses","Social Contract"], ["law","government","democracy","citizen","freedom"], ["political","provoking"], "long", {category:"politics"}),
      mk(36, "wealth-of-nations", "Adam Smith", ["Adam Smith"], ["The Wealth of Nations"], ["wealth","labor","government","law","progress"], ["analytical","dry"], "long", {category:"social-science"}),
      mk(37, "gibbon-1", "Gibbon (Vol. I)", ["Edward Gibbon"], ["Decline and Fall"], ["history","religion","state","war"], ["big","serious"], "long", {category:"history"}),
      mk(38, "gibbon-2", "Gibbon (Vol. II)", ["Edward Gibbon"], ["Decline and Fall (cont.)"], ["history","religion","state","war"], ["big","serious"], "long", {category:"history"}),
      mk(39, "kant", "Kant", ["Immanuel Kant"], ["Major works"], ["duty","reasoning","ethics","knowledge","freedom"], ["demanding","sharp"], "long", {category:"philosophy"}),

      mk(40, "american-papers-mill", "American State Papers / Federalist / J.S. Mill", ["Various","James Madison et al.","John Stuart Mill"], ["Founding docs","Federalist Papers","Selected works"], ["liberty","law","democracy","citizen","government"], ["clear","practical"], "long", {category:"politics"}),
      mk(41, "boswell-johnson", "Boswell", ["James Boswell"], ["Life of Samuel Johnson"], ["character","conversation","virtue","education"], ["warm","human"], "long", {category:"biography", comfortTag:true}),
      mk(42, "lavoisier-faraday", "Lavoisier / Faraday", ["Antoine Lavoisier","Michael Faraday"], ["Elements of Chemistry","Electricity"], ["science","cause","nature","experiment"], ["curious","clear"], "medium", {category:"science"}),
      mk(43, "hegel-kierkegaard-nietzsche", "Hegel / Kierkegaard / Nietzsche", ["G.W.F. Hegel","Søren Kierkegaard","Friedrich Nietzsche"], ["Selected works"], ["self","truth","religion","morality","freedom"], ["intense","provoking"], "long", {category:"philosophy"}),
      mk(44, "tocqueville", "Tocqueville", ["Alexis de Tocqueville"], ["Democracy in America"], ["democracy","citizen","equality","liberty","state"], ["observant","clear"], "long", {category:"politics"}),
      mk(45, "goethe-balzac", "Goethe / Balzac", ["Johann Wolfgang von Goethe","Honoré de Balzac"], ["Faust","Cousin Bette"], ["desire","ambition","love","society","good-and-evil"], ["imaginative","human"], "long", {category:"imaginative"}),
      mk(46, "austen-eliot", "Austen / George Eliot", ["Jane Austen","George Eliot"], ["Emma","Middlemarch"], ["love","custom","society","virtue-and-vice","judgment"], ["comfort","human"], "long", {category:"imaginative", comfortTag:true}),
      mk(47, "little-dorrit", "Dickens", ["Charles Dickens"], ["Little Dorrit"], ["justice","law","wealth","society","character"], ["big","human"], "long", {category:"imaginative"}),
      mk(48, "moby-huck", "Melville / Twain", ["Herman Melville","Mark Twain"], ["Moby-Dick","Huckleberry Finn"], ["truth","freedom","society","evil","adventure"], ["imaginative","varied"], "long", {category:"imaginative"}),
      mk(49, "darwin", "Darwin", ["Charles Darwin"], ["Origin of Species","Descent of Man"], ["evolution","nature","man","science"], ["curious","grounding"], "long", {category:"science"}),

      mk(50, "marx-engels", "Marx / Engels", ["Karl Marx","Friedrich Engels"], ["Communist Manifesto","Capital (Vol. I)"], ["labor","wealth","state","revolution","justice"], ["hard","systemic"], "long", {category:"social-science"}),
      mk(51, "war-and-peace", "Tolstoy", ["Leo Tolstoy"], ["War and Peace"], ["war","history","love","fate","honor"], ["epic","immersive"], "long", {category:"imaginative"}),
      mk(52, "karamazov-ibsen", "Dostoevsky / Ibsen", ["Fyodor Dostoevsky","Henrik Ibsen"], ["Brothers Karamazov","Selected plays"], ["god","sin","free-will","family","truth"], ["intense","moral"], "long", {category:"imaginative"}),
      mk(53, "william-james", "William James", ["William James"], ["Principles of Psychology"], ["mind","habit","emotion","experience"], ["analytical","curious"], "long", {category:"social-science"}),
      mk(54, "freud", "Freud", ["Sigmund Freud"], ["Major works"], ["mind","desire","dreams","emotion","self"], ["probing","mixed"], "long", {category:"social-science"}),

      mk(55, "20c-phil-religion", "20th Century Philosophy & Religion", ["Various"], ["Selections"], ["mind","truth","religion","reasoning","language"], ["modern","varied"], "long", {category:"philosophy"}),
      mk(56, "20c-natural-science", "20th Century Natural Science", ["Various"], ["Selections"], ["science","physics","nature","truth","hypothesis"], ["modern","precise"], "long", {category:"science"}),
      mk(57, "20c-social-1", "20th Century Social Science I", ["Various"], ["Selections"], ["wealth","labor","state","economics","progress"], ["modern","systemic"], "medium", {category:"social-science"}),
      mk(58, "20c-social-2", "20th Century Social Science II", ["Various"], ["Selections"], ["culture","religion","society","history"], ["modern","wide"], "medium", {category:"social-science"}),
      mk(59, "20c-lit-1", "20th Century Imaginative Literature I", ["Various"], ["Selections"], ["self","society","love","truth","meaning"], ["modern","varied"], "long", {category:"imaginative"}),
      mk(60, "20c-lit-2", "20th Century Imaginative Literature II", ["Various"], ["Selections"], ["self","society","love","truth","meaning"], ["modern","varied"], "long", {category:"imaginative"})
    ];

    function mk(volume, slug, title, authors, works, themes, moods, length, extra = {}) {
      const category = extra.category ?? "general";
      const comfortTag = !!extra.comfortTag;
      return {
        id: volume,
        volume,
        slug,
        title,
        authors: Array.isArray(authors) ? authors : [],
        works: Array.isArray(works) ? works : [],
        themes: uniq(Array.isArray(themes) ? themes : []),
        moods: uniq(Array.isArray(moods) ? moods : []),
        length,             // short | medium | long | reference
        category,           // philosophy | imaginative | science | etc
        comfortTag
      };
    }

    function uniq(arr) { return [...new Set(arr.map(String))]; }

    // ------------------------------------
    // Feeling/idea → signals (lexicon)
    // ------------------------------------
    const LEXICON = [
      { match: ["sick","ill","flu","fever","headache","nauseous","exhausted","burnt","burned","burnout","tired","wiped","drained"], moods:["low-energy","comfort","gentle"], themes:["mind","medicine","life-and-death","habit"], w: 3 },
      { match: ["don’t want","dont want","can't","cant","no energy","unmotivated","procrastinating","stuck","frozen"], moods:["low-energy","clarity"], themes:["habit","desire","happiness","will"], w: 3 },

      { match: ["anxious","anxiety","panic","worried","afraid","fear","overwhelmed","stress","stressed"], moods:["calm","clarity"], themes:["courage","prudence","mind","reasoning"], w: 3 },

      { match: ["sad","grieving","grief","lonely","heartbroken","loss","depressed"], moods:["comfort","gentle"], themes:["love","life-and-death","soul","time"], w: 3 },

      { match: ["angry","rage","furious","resent","unfair","injustice","betrayed"], moods:["clarity","serious"], themes:["justice","law","good-and-evil","virtue-and-vice"], w: 3 },

      { match: ["meaning","purpose","directionless","lost","what’s the point","whats the point","existential"], moods:["reflective","clarity"], themes:["truth","happiness","virtue","wisdom","soul"], w: 3 },

      { match: ["motivation","discipline","consistent","routine","habit","self control","self-control","focus"], moods:["focused","clarity"], themes:["habit","virtue","prudence","duty","reasoning"], w: 3 },

      { match: ["relationship","marriage","partner","love","jealous","friend","friendship"], moods:["reflective","comfort"], themes:["love","virtue-and-vice","family","desire"], w: 3 },

      { match: ["government","state","politics","democracy","liberty","rights","law","tyranny"], moods:["serious","clear-eyed"], themes:["government","law","liberty","democracy","citizen","tyranny"], w: 3 },

      { match: ["science","physics","math","astronomy","chemistry","evolution","proof","logic"], moods:["curious","precise"], themes:["science","physics","mathematics","astronomy","reasoning"], w: 3 },
    ];

    const THEME_SYNONYMS = {
      "life and death": "life-and-death",
      "good and evil": "good-and-evil",
      "virtue and vice": "virtue-and-vice",
      "war and peace": "war",
      "freedom": "liberty",
      "self": "mind",
      "soul": "soul"
    };

    // ------------------------------------
    // UI + State
    // ------------------------------------
    const els = {
      q: $("#q"),
      btnGo: $("#btnGo"),
      btnClear: $("#btnClear"),
      tabCompass: $("#tabCompass"),
      tabBrowse: $("#tabBrowse"),
      compassSection: $("#compassSection"),
      results: $("#results"),
      emptyState: $("#emptyState"),
      chips: $("#chips"),
      explain: $("#explain"),
      btnExplain: $("#btnExplain"),
      signalList: $("#signalList"),
      shelf: $("#shelf"),
      librarySearch: $("#librarySearch"),
      libraryGrid: $("#libraryGrid"),
      btnResetFilters: $("#btnResetFilters"),
      btnExport: $("#btnExport"),
      modal: $("#modal"),
      modalClose: $("#modalClose"),
      modalOverlay: $("#modalOverlay"),
      modalTitle: $("#modalTitle"),
      modalMeta: $("#modalMeta"),
      modalBody: $("#modalBody"),
      modalOpenFile: $("#modalOpenFile"),
      modalStar: $("#modalStar"),
    };

    const state = {
      mode: "compass",
      activeQuickFilter: null,
      libraryQuery: "",
      shelf: loadShelf(),
      lastSignals: null,
      lastResults: []
    };

    // ------------------------------------
    // Init
    // ------------------------------------
    boot();
    function boot() {
      wire();
      renderChips();
      renderShelf();
      renderLibrary();
      setMode("compass");

      // hash query support for sharing
      const u = new URL(location.href);
      const q = u.hash.startsWith("#q=") ? decodeURIComponent(u.hash.slice(3)) : "";
      if (q) {
        els.q.value = q;
        runCompass(q);
      }
    }

    function wire() {
      // Ctrl+K focus
      window.addEventListener("keydown", (e) => {
        const isMac = navigator.platform.toUpperCase().includes("MAC");
        const mod = isMac ? e.metaKey : e.ctrlKey;
        if (mod && e.key.toLowerCase() === "k") {
          e.preventDefault();
          els.q.focus();
        }
        if (e.key === "Escape") closeModal();
      });

      els.btnGo.addEventListener("click", () => runCompass(els.q.value));
      els.btnClear.addEventListener("click", () => {
        els.q.value = "";
        location.hash = "";
        state.lastSignals = null;
        state.lastResults = [];
        els.results.innerHTML = "";
        els.emptyState.classList.remove("hidden");
        els.signalList.innerHTML = "";
      });

      els.q.addEventListener("keydown", (e) => {
        if (e.key === "Enter") runCompass(els.q.value);
      });

      els.tabCompass.addEventListener("click", () => setMode("compass"));
      els.tabBrowse.addEventListener("click", () => setMode("browse"));

      els.btnExplain.addEventListener("click", () => {
        els.explain.classList.toggle("hidden");
      });

      els.librarySearch.addEventListener("input", (e) => {
        state.libraryQuery = e.target.value;
        renderLibrary();
      });

      els.btnResetFilters.addEventListener("click", () => {
        state.activeQuickFilter = null;
        state.libraryQuery = "";
        els.librarySearch.value = "";
        [...document.querySelectorAll(".filterBtn")].forEach(b => b.classList.remove("bg-indigo-500/30","ring-indigo-300/30"));
        renderLibrary();
      });

      document.querySelectorAll(".filterBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const f = btn.dataset.filter;
          state.activeQuickFilter = (state.activeQuickFilter === f) ? null : f;
          document.querySelectorAll(".filterBtn").forEach(b => b.classList.remove("bg-indigo-500/30","ring-indigo-300/30"));
          if (state.activeQuickFilter) btn.classList.add("bg-indigo-500/30","ring-indigo-300/30");
          renderLibrary();
        });
      });

      els.btnExport.addEventListener("click", exportBookFiles);

      els.modalClose.addEventListener("click", closeModal);
      els.modalOverlay.addEventListener("click", closeModal);
    }

    function setMode(mode) {
      state.mode = mode;
      if (mode === "compass") {
        els.tabCompass.className = "px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/15 transition text-sm";
        els.tabBrowse.className  = "px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm";
        if (els.q.value.trim()) document.querySelector("#compassSection").scrollIntoView({block:"start"});
      } else {
        els.tabCompass.className = "px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm";
        els.tabBrowse.className  = "px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/15 transition text-sm";
        document.querySelector("#library").scrollIntoView({block:"start"});
      }
    }

    // ------------------------------------
    // Compass logic
    // ------------------------------------
    function runCompass(input) {
      const text = (input ?? "").trim();
      if (!text) return;

      location.hash = "#q=" + encodeURIComponent(text);

      const signals = extractSignals(text);
      state.lastSignals = signals;

      const scored = BOOKS
        .map(b => ({ book: b, ...scoreBook(b, signals) }))
        .sort((a,b) => b.score - a.score)
        .slice(0, 8);

      const topScore = scored[0]?.score ?? 0;
      const results = (topScore > 0) ? scored : fallbackPicks(text);

      state.lastResults = results;

      renderSignals(signals);
      renderResults(results, signals);
      els.emptyState.classList.add("hidden");
    }

    function extractSignals(text) {
      const raw = text.toLowerCase();
      const normalized = raw
        .replace(/[’']/g, "'")
        .replace(/[^a-z0-9\s\-']/g, " ")
        .replace(/\s+/g, " ")
        .trim();

      const themes = new Map();
      const moods  = new Map();
      const hits   = [];

      for (const key of Object.keys(THEME_SYNONYMS)) {
        if (normalized.includes(key)) add(themes, THEME_SYNONYMS[key], 2, hits, `phrase:${key}`);
      }

      for (const rule of LEXICON) {
        const found = rule.match.some(m => normalized.includes(m));
        if (!found) continue;

        hits.push(...rule.match.filter(m => normalized.includes(m)).map(m => `match:${m}`));
        rule.themes.forEach(t => add(themes, t, rule.w, hits, `theme:${t}`));
        rule.moods.forEach(m => add(moods, m, rule.w, hits, `mood:${m}`));
      }

      if (/\b(why|what|how)\b/.test(normalized)) add(moods, "inquiry", 1, hits, "question");
      if (/\b(today|right now|tonight)\b/.test(normalized)) add(moods, "immediate", 1, hits, "time");

      const directThemes = [
        "justice","liberty","truth","love","law","duty","happiness","wisdom","mind","soul","god",
        "war","government","science","mathematics","nature","history","education","virtue","desire"
      ];
      for (const t of directThemes) {
        if (normalized.includes(t)) add(themes, t, 2, hits, `direct:${t}`);
      }

      const cleanedThemes = new Map();
      for (const [k,v] of themes.entries()) cleanedThemes.set(k.replace(/\s+/g, "-"), v);

      return {
        input: text,
        normalized,
        themes: cleanedThemes,
        moods,
        hits: uniq(hits),
      };
    }

    function add(map, key, n) {
      map.set(key, (map.get(key) ?? 0) + n);
    }

    function scoreBook(book, signals) {
      let score = 0;
      const hits = [];

      for (const [t, w] of signals.themes.entries()) {
        if (book.themes.includes(t) || book.themes.includes(t.replace(/-/g," "))) {
          score += w * 2;
          hits.push(`theme:${t}`);
        }
      }

      for (const [m, w] of signals.moods.entries()) {
        if (book.moods.includes(m)) {
          score += w * 2;
          hits.push(`mood:${m}`);
        }
      }

      const lowEnergy = (signals.moods.get("low-energy") ?? 0) >= 3 || (signals.moods.get("comfort") ?? 0) >= 3;
      if (lowEnergy) {
        if (book.length === "short") score += 6;
        if (book.length === "medium") score += 3;
        if (book.comfortTag) score += 5;
        if (book.title.includes("Montaigne") || book.title.includes("Erasmus") || book.title.includes("Swift")) score += 2;
      }

      if ((signals.themes.get("science") ?? 0) > 0 && book.category === "science") score += 3;
      if ((signals.themes.get("government") ?? 0) > 0 && ["politics","history"].includes(book.category)) score += 2;

      if (book.length === "reference") score -= 4;
      if (signals.normalized.includes("syntopicon") || signals.normalized.includes("index")) {
        if (book.slug.startsWith("the-syntopicon")) score += 10;
      }

      return { score, hits: uniq(hits) };
    }

    function fallbackPicks() {
      const defaults = ["late-antiquity","erasmus-montaigne","swift-voltaire-diderot","boswell-johnson","austen-eliot"];
      return defaults
        .map(slug => BOOKS.find(b => b.slug === slug))
        .filter(Boolean)
        .map((b, i) => ({ book: b, score: 10 - i, hits: ["fallback"] }));
    }

    // ------------------------------------
    // Render
    // ------------------------------------
    function renderChips() {
      const suggestions = [
        "I feel sick and don’t want to do anything",
        "I’m anxious and overthinking",
        "I’m angry and feel treated unfairly",
        "I feel lost and need meaning",
        "I need discipline and focus",
        "What is justice?",
        "I need courage"
      ];
      els.chips.innerHTML = suggestions.map(s => `
        <button class="px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-xs transition"
          data-chip="${esc(s)}">${esc(s)}</button>
      `).join("");

      els.chips.querySelectorAll("button[data-chip]").forEach(btn => {
        btn.addEventListener("click", () => {
          const v = btn.dataset.chip;
          els.q.value = v;
          runCompass(v);
          els.q.focus();
        });
      });
    }

    function renderSignals(signals) {
      if (!signals) {
        els.signalList.innerHTML = `<div class="text-zinc-400/80 text-sm">No signals yet.</div>`;
        return;
      }

      const themes = [...signals.themes.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8);
      const moods  = [...signals.moods.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8);

      const chip = (label, kind="") => `
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-white/5 ring-1 ring-white/10 text-xs">
          <span class="opacity-70">${kind}</span><span>${esc(label)}</span>
        </span>`;

      els.signalList.innerHTML = `
        <div class="space-y-3">
          <div>
            <div class="text-xs text-zinc-400 uppercase tracking-wide">Top themes</div>
            <div class="mt-2 flex flex-wrap gap-2">
              ${themes.length ? themes.map(([t,w]) => chip(`${t} (${w})`, "T")).join("") : `<span class="text-zinc-400/80">None</span>`}
            </div>
          </div>
          <div>
            <div class="text-xs text-zinc-400 uppercase tracking-wide">Top moods</div>
            <div class="mt-2 flex flex-wrap gap-2">
              ${moods.length ? moods.map(([m,w]) => chip(`${m} (${w})`, "M")).join("") : `<span class="text-zinc-400/80">None</span>`}
            </div>
          </div>
        </div>
      `;
    }

    function renderResults(results, signals) {
      els.results.innerHTML = results.map((r, idx) => {
        const b = r.book;
        const why = buildWhy(b, r, signals);
        const tags = [
          ...b.themes.slice(0,6).map(t => badge(t, "theme")),
          ...b.moods.slice(0,4).map(m => badge(m, "mood")),
          badge(b.category, "cat"),
          badge(b.length, "len")
        ].join("");

        const starred = !!state.shelf[b.slug];

        return `
          <article class="rounded-2xl bg-white/4 ring-1 ring-white/10 hover:bg-white/6 transition shadow-soft overflow-hidden">
            <div class="p-4 sm:p-5">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-xs text-zinc-400/80">Rank #${idx+1} • Score <span class="text-zinc-200">${r.score}</span> • Vol. ${b.volume}</div>
                  <h3 class="mt-1 text-lg font-semibold leading-snug">${esc(b.title)}</h3>
                  <div class="mt-1 text-sm text-zinc-300/80">${esc(b.authors.join(" • "))}</div>
                </div>

                <div class="flex items-center gap-2">
                  <button data-star="${esc(b.slug)}"
                    class="px-3 py-2 rounded-xl ${starred ? "bg-yellow-500/20 ring-yellow-300/20" : "bg-white/5 ring-white/10"} hover:bg-white/10 ring-1 transition text-sm">
                    ${starred ? "★" : "☆"}
                  </button>
                  <button data-open="${esc(b.slug)}"
                    class="px-3 py-2 rounded-xl bg-indigo-500/90 hover:bg-indigo-500 ring-1 ring-indigo-300/30 shadow-soft transition text-sm font-medium">
                    Details
                  </button>
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">${tags}</div>

              <div class="mt-4 rounded-xl bg-zinc-950/40 ring-1 ring-white/10 p-3 text-sm text-zinc-200/85">
                <div class="text-xs uppercase tracking-wide text-zinc-400">Why this match</div>
                <div class="mt-1">${why}</div>
              </div>
            </div>
          </article>
        `;
      }).join("");

      els.results.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.dataset.open));
      });
      els.results.querySelectorAll("button[data-star]").forEach(btn => {
        btn.addEventListener("click", () => toggleStar(btn.dataset.star));
      });
    }

    function buildWhy(book, scored, signals) {
      const themeHits = (scored.hits ?? []).filter(h => h.startsWith("theme:")).map(h => h.slice(6));
      const moodHits  = (scored.hits ?? []).filter(h => h.startsWith("mood:")).map(h => h.slice(5));

      const bits = [];
      if (themeHits.length) bits.push(`Theme overlap: <b>${esc(themeHits.slice(0,5).join(", "))}</b>.`);
      if (moodHits.length)  bits.push(`Mood fit: <b>${esc(moodHits.slice(0,4).join(", "))}</b>.`);

      const lowEnergy = (signals?.moods?.get("low-energy") ?? 0) >= 3 || (signals?.moods?.get("comfort") ?? 0) >= 3;
      if (lowEnergy && (book.length === "short" || book.length === "medium" || book.comfortTag)) {
        bits.push(`You sounded low-energy, so I biased toward <b>accessible / comforting</b> works.`);
      }

      if (book.slug === "late-antiquity") bits.push(`This volume includes <b>Epictetus</b> and <b>Meditations</b>—great for “I can’t do much today.”`);
      if (book.slug === "erasmus-montaigne") bits.push(`Montaigne’s essays are ideal for gentle reflection without heavy commitment.`);
      if (!bits.length) bits.push(`Good all-purpose entry point based on your input.`);

      return bits.join(" ");
    }

    function badge(label, kind) {
      const base = "px-2 py-1 rounded-lg text-xs ring-1";
      const styles = {
        theme: `${base} bg-indigo-500/10 ring-indigo-300/20 text-indigo-200`,
        mood:  `${base} bg-emerald-500/10 ring-emerald-300/20 text-emerald-200`,
        cat:   `${base} bg-white/5 ring-white/10 text-zinc-200/80`,
        len:   `${base} bg-white/5 ring-white/10 text-zinc-200/80`
      };
      return `<span class="${styles[kind] ?? styles.cat}">${esc(label)}</span>`;
    }

    function renderShelf() {
      const items = Object.values(state.shelf);
      if (!items.length) {
        els.shelf.innerHTML = `<div class="text-sm text-zinc-400/80">No starred books yet.</div>`;
        return;
      }
      els.shelf.innerHTML = items
        .sort((a,b)=>a.volume-b.volume)
        .map(b => `
          <button data-open="${esc(b.slug)}"
            class="w-full text-left px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition">
            <div class="text-xs text-zinc-400/80">Vol. ${b.volume}</div>
            <div class="text-sm font-medium">${esc(b.title)}</div>
            <div class="text-xs text-zinc-400/80">${esc(b.authors.join(" • "))}</div>
          </button>
        `).join("");

      els.shelf.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.dataset.open));
      });
    }

    function renderLibrary() {
      const q = (state.libraryQuery ?? "").trim().toLowerCase();
      const f = state.activeQuickFilter;

      const filtered = BOOKS.filter(b => {
        if (f === "short" && !["short","medium"].includes(b.length)) return false;
        if (f === "fiction" && b.category !== "imaginative") return false;
        if (f === "philosophy" && b.category !== "philosophy") return false;
        if (f === "science" && b.category !== "science") return false;
        if (f === "comfort" && !b.comfortTag) return false;

        if (!q) return true;
        const hay = [
          b.title, b.authors.join(" "), b.works.join(" "),
          b.themes.join(" "), b.moods.join(" "), b.category, b.length
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });

      els.libraryGrid.innerHTML = filtered.map(b => {
        const starred = !!state.shelf[b.slug];
        const meta = `${b.authors.join(" • ")}`;
        const topTags = [...b.themes.slice(0,4), ...b.moods.slice(0,2)].slice(0,6);

        return `
          <article class="rounded-2xl bg-white/4 ring-1 ring-white/10 hover:bg-white/6 transition shadow-soft overflow-hidden">
            <div class="p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-xs text-zinc-400/80">Vol. ${b.volume} • ${esc(b.category)} • ${esc(b.length)}</div>
                  <div class="mt-1 font-semibold">${esc(b.title)}</div>
                  <div class="mt-1 text-xs text-zinc-300/75">${esc(meta)}</div>
                </div>
                <div class="flex items-center gap-2">
                  <button data-star="${esc(b.slug)}"
                    class="px-3 py-2 rounded-xl ${starred ? "bg-yellow-500/20 ring-yellow-300/20" : "bg-white/5 ring-white/10"} hover:bg-white/10 ring-1 transition text-sm">
                    ${starred ? "★" : "☆"}
                  </button>
                  <button data-open="${esc(b.slug)}"
                    class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 transition text-sm">
                    Open
                  </button>
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                ${topTags.map(t => badge(t, b.themes.includes(t) ? "theme" : "mood")).join("")}
              </div>
            </div>
          </article>
        `;
      }).join("");

      els.libraryGrid.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.dataset.open));
      });
      els.libraryGrid.querySelectorAll("button[data-star]").forEach(btn => {
        btn.addEventListener("click", () => toggleStar(btn.dataset.star));
      });
    }

    // ------------------------------------
    // Modal
    // ------------------------------------
    function openModal(slug) {
      const b = BOOKS.find(x => x.slug === slug);
      if (!b) return;

      els.modalTitle.textContent = `${b.title}`;
      els.modalMeta.textContent  = `Vol. ${b.volume} • ${b.authors.join(" • ")} • ${b.category} • ${b.length}`;
      els.modalOpenFile.href     = `books/${b.slug}.html`;
      els.modalStar.textContent  = state.shelf[b.slug] ? "Unstar" : "Star";

      const works = b.works?.length ? `
        <div>
          <div class="text-xs uppercase tracking-wide text-zinc-400">Works included</div>
          <ul class="mt-2 list-disc pl-5 space-y-1">
            ${b.works.map(w => `<li>${esc(w)}</li>`).join("")}
          </ul>
        </div>` : "";

      const themes = `
        <div>
          <div class="text-xs uppercase tracking-wide text-zinc-400">Themes</div>
          <div class="mt-2 flex flex-wrap gap-2">${b.themes.map(t => badge(t,"theme")).join("")}</div>
        </div>`;
      const moods = `
        <div>
          <div class="text-xs uppercase tracking-wide text-zinc-400">Moods</div>
          <div class="mt-2 flex flex-wrap gap-2">${b.moods.map(m => badge(m,"mood")).join("")}</div>
        </div>`;

      els.modalBody.innerHTML = `
        ${works}
        ${themes}
        ${moods}
        <div class="rounded-xl bg-white/5 ring-1 ring-white/10 p-3 text-sm">
          <div class="text-xs uppercase tracking-wide text-zinc-400">Quick use</div>
          <div class="mt-1 text-zinc-200/85">
            If you want a <b>short entry</b>, read a single section/chapter and then ask:
            <ul class="mt-2 list-disc pl-5 space-y-1 text-zinc-200/75">
              <li>What problem is the author trying to solve?</li>
              <li>What do they assume about human nature?</li>
              <li>Where do I agree—and where do I resist?</li>
            </ul>
          </div>
        </div>
      `;

      els.modalStar.onclick = () => toggleStar(b.slug, true);
      els.modal.classList.remove("hidden");
    }

    function closeModal() {
      els.modal.classList.add("hidden");
    }

    // ------------------------------------
    // Shelf (localStorage)
    // ------------------------------------
    function loadShelf() {
      try {
        const raw = localStorage.getItem("gbww_shelf");
        const obj = raw ? JSON.parse(raw) : {};
        return obj && typeof obj === "object" ? obj : {};
      } catch { return {}; }
    }
    function saveShelf() {
      localStorage.setItem("gbww_shelf", JSON.stringify(state.shelf));
    }
    function toggleStar(slug, refreshModal = false) {
      const b = BOOKS.find(x => x.slug === slug);
      if (!b) return;
      if (state.shelf[slug]) delete state.shelf[slug];
      else state.shelf[slug] = b;
      saveShelf();
      renderShelf();
      renderLibrary();
      if (state.lastSignals) renderResults(state.lastResults, state.lastSignals);
      if (refreshModal) els.modalStar.textContent = state.shelf[slug] ? "Unstar" : "Star";
    }

    // ------------------------------------
    // Export: generate one file per book
    // ------------------------------------
    function exportBookFiles() {
      const ok = confirm(
        "This will download 60 standalone HTML files (one per volume). Your browser may ask permission for multiple downloads.\n\nProceed?"
      );
      if (!ok) return;

      for (const b of BOOKS) {
        const html = buildBookHtml(b);
        downloadFile(`${b.slug}.html`, html, "text/html;charset=utf-8");
      }

      downloadFile(`books.json`, JSON.stringify(BOOKS, null, 2), "application/json;charset=utf-8");
      alert("Downloads triggered. Create a /books folder in your repo and move the generated .html files into it.");
    }

    // ✅ FIXED: no nested template-literal hazards; interpolation always runs
    function buildBookHtml(b) {
      const worksItems = (b.works?.length ?? 0)
        ? b.works.map(w => `<li class="text-zinc-200/85">${esc(w)}</li>`).join("")
        : "";

      const worksSection = worksItems
        ? `
          <div class="mt-5">
            <div class="text-xs uppercase tracking-wide text-zinc-400">Works included</div>
            <ul class="mt-2 list-disc pl-5 space-y-1">${worksItems}</ul>
          </div>
        `
        : "";

      const themeChips = (b.themes ?? []).map(t =>
        `<span class="px-2 py-1 rounded-lg text-xs bg-indigo-500/10 ring-1 ring-indigo-300/20 text-indigo-200">${esc(t)}</span>`
      ).join("");

      const moodChips = (b.moods ?? []).map(m =>
        `<span class="px-2 py-1 rounded-lg text-xs bg-emerald-500/10 ring-1 ring-emerald-300/20 text-emerald-200">${esc(m)}</span>`
      ).join("");

      return `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vol. ${b.volume} • ${esc(b.title)}</title>
  <meta name="description" content="GBWW Vol. ${b.volume}: ${esc(b.title)}" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-zinc-950 text-zinc-100 font-sans">
  <main class="mx-auto max-w-3xl px-5 py-10">
    <a href="../index.html#library" class="inline-flex items-center gap-2 text-sm text-zinc-300/80 hover:text-zinc-100">
      <span aria-hidden="true">←</span> Back to library
    </a>

    <div class="mt-6 rounded-2xl bg-white/4 ring-1 ring-white/10 shadow-xl overflow-hidden">
      <div class="p-5">
        <div class="text-xs text-zinc-400/80">Vol. ${b.volume} • ${esc(b.category)} • ${esc(b.length)}</div>
        <h1 class="mt-1 text-2xl font-semibold">${esc(b.title)}</h1>
        <div class="mt-2 text-sm text-zinc-300/80">${esc((b.authors ?? []).join(" • "))}</div>

        ${worksSection}

        <div class="mt-5">
          <div class="text-xs uppercase tracking-wide text-zinc-400">Themes</div>
          <div class="mt-2 flex flex-wrap gap-2">${themeChips}</div>
        </div>

        <div class="mt-5">
          <div class="text-xs uppercase tracking-wide text-zinc-400">Moods</div>
          <div class="mt-2 flex flex-wrap gap-2">${moodChips}</div>
        </div>

        <div class="mt-6 rounded-xl bg-zinc-950/50 ring-1 ring-white/10 p-4 text-sm text-zinc-200/85">
          <div class="text-xs uppercase tracking-wide text-zinc-400">Reading prompt</div>
          <div class="mt-1">
            Read a single section and answer:
            <ul class="mt-2 list-disc pl-5 space-y-1 text-zinc-200/75">
              <li>What’s the author’s central claim?</li>
              <li>What would a smart critic object to?</li>
              <li>What changes in my thinking after 20 minutes?</li>
            </ul>
          </div>
        </div>

        <div class="mt-6 flex flex-wrap gap-2">
          <a href="../index.html" class="px-3 py-2 rounded-xl bg-indigo-500/90 hover:bg-indigo-500 ring-1 ring-indigo-300/30 text-sm font-medium">Open Compass</a>
          <a href="../index.html#library" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-sm">Open Library</a>
        </div>
      </div>
    </div>

    <p class="mt-6 text-xs text-zinc-500">
      Generated locally from the Compass site. Edit tags in <code class="text-zinc-300">index.html</code> to improve recommendations over time.
    </p>
  </main>
</body>
</html>`;
    }

    function downloadFile(filename, content, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    // ------------------------------------
    // Utils
    // ------------------------------------
    function $(sel) { return document.querySelector(sel); }

    function esc(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
  </script>
</body>
</html>
